{% extends "base.html" %}

{% block content %}
<h2>Welcome, Coach {{ user.name }}</h2>

<!-- Add date filter form -->
<form method="GET" class="mb-4">
    <div class="row align-items-end">
        <div class="col-auto">
            <label for="location_filter">Location:</label>
            <select id="location_filter" name="location_filter" class="form-control">
                <option value="">All Locations</option>
                {% for location in locations %}
                    <option value="{{ location }}" {% if location == selected_location %}selected{% endif %}>
                        {{ location }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <label for="date_filter">Date:</label>
            <input type="date" id="date_filter" name="date_filter" class="form-control" 
                   value="{{ selected_date }}" onchange="updateTimeSlots(this.value)">
        </div>
        
        <div class="col-auto">
            <label for="time_filter">Time:</label>
            <select id="time_filter" name="time_filter" class="form-control">
                <option value="">All Times</option>
                {% for time in time_slots %}
                    <option value="{{ time }}" {% if time == selected_time %}selected{% endif %}>
                        {{ time }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-auto">
            <button type="submit" class="btn btn-primary btn-sm">Filter</button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-sm">Reset</a>
        </div>
    </div>
</form>

<h3>Registrations</h3>
<form method="POST" action="{{ url_for('check_users') }}">
    <input type="hidden" name="date_filter" value="{{ selected_date }}">
    <table class="table">
        <thead>
            <tr>
                <th>User Name</th>
                <th>Session Location</th>
                <th>Session Day</th>
                <th>Session Date</th>
                <th>Time</th>
                <th>Mark Attendance</th>
            </tr>
        </thead>
        <tbody>
            {% for reg in registrations %}
            <tr>
                <td>{{ reg.user_name }}</td>
                <td>{{ reg.location }}</td>
                <td>{{ reg.day }}</td>
                <td>{{ reg.session_date.strftime('%Y-%m-%d') }}</td>
                <td>{{ reg.start_time }} - {{ reg.end_time }}</td>
                <td>
                    <input type="checkbox" name="checked_users" value="{{ reg.Registration.id }}">
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary mb-4">Submit Attendance</button>
</form>

{% if not registrations %}
<p>No registrations found for the selected date.</p>
{% endif %}

<!-- Add this JavaScript at the bottom of your template -->
<script>
function updateTimeSlots(date) {
    // Make an AJAX request to get time slots for the selected date
    fetch(`/get_time_slots?date=${date}`)
        .then(response => response.json())
        .then(data => {
            const timeSelect = document.getElementById('time_filter');
            timeSelect.innerHTML = '<option value="">All Times</option>';
            
            data.time_slots.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;
                timeSelect.appendChild(option);
            });
            
            // Automatically submit the form after updating time slots
            document.querySelector('form').submit();
        });
}
</script>
{% endblock %} 